<ion-header>
  <ion-toolbar color="primary">
    <ion-title>ValidaDocs</ion-title>
    <ion-buttons slot="end">
      <ion-button [disabled]="loading()" (click)="refresh()">
        {{ loading() ? 'Atualizando...' : 'Atualizar' }}
      </ion-button>
      <ion-button (click)="openGenerateToken()">GERAR TOKEN</ion-button>
      <ion-button (click)="logout()">SAIR</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen>
  <div class="wrap">
    <!-- Filtros + Busca -->
    <div class="toolbar">
      <ion-item lines="none" class="compact">
        <ion-label>Período</ion-label>
        <ion-select
          [value]="period()"
          interface="popover"
          class="select-filter"
          (ionChange)="period.set($any($event.detail.value))">
          <ion-select-option value="Todos">Todos</ion-select-option>
          <ion-select-option value="7d">Últimos 7 dias</ion-select-option>
          <ion-select-option value="30d">Últimos 30 dias</ion-select-option>
          <ion-select-option value="90d">Últimos 90 dias</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item lines="none" class="compact">
        <ion-label>Status</ion-label>
        <ion-select
          [value]="status()"
          interface="popover"
          class="select-filter"
          (ionChange)="status.set($any($event.detail.value))">
          <ion-select-option value="Todos">Todos</ion-select-option>
          <ion-select-option value="Ativo">Ativo</ion-select-option>
          <ion-select-option value="Inativo">Inativo</ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Busca à direita -->
      <ion-searchbar
        class="toolbar-search"
        placeholder="Buscar por empresa, email, doc, telefone ou token"
        [value]="query()"
        (ionInput)="query.set($event.detail.value ?? '')"
        (keyup.enter)="page.set(1)">
      </ion-searchbar>
    </div>

    <!-- Lista -->
    <ion-card class="list">
      <ion-card-content>

        <!-- Skeleton -->
        <ng-container *ngIf="loading(); else content">
          <ion-grid class="table">
            <ion-row class="thead">
              <ion-col size="4">Usuário / Empresa</ion-col>
              <ion-col size="4">Token</ion-col>
              <ion-col size="2">Status</ion-col>
              <ion-col size="2" class="acoes">Ações</ion-col>
            </ion-row>

            <ion-row class="trow" *ngFor="let i of [1,2,3,4,5,6,7]">
              <ion-col size="4">
                <ion-skeleton-text animated style="width: 60%"></ion-skeleton-text>
                <ion-skeleton-text animated style="width: 40%; margin-top:6px"></ion-skeleton-text>
              </ion-col>
              <ion-col size="4">
                <ion-skeleton-text animated style="width: 90%"></ion-skeleton-text>
                <ion-chip size="small">
                  <ion-skeleton-text animated style="width: 120px; height: 14px"></ion-skeleton-text>
                </ion-chip>
              </ion-col>
              <ion-col size="2"><ion-badge color="medium">•••</ion-badge></ion-col>
              <ion-col size="2" class="acoes"><span class="link muted">ver detalhes</span></ion-col>
            </ion-row>
          </ion-grid>
        </ng-container>

        <!-- Conteúdo -->
        <ng-template #content>
          <ion-grid class="table">
            <ion-row class="thead">
              <ion-col size="4">Usuário / Empresa</ion-col>
              <ion-col size="4">Token</ion-col>
              <ion-col size="2">Status</ion-col>
              <ion-col size="2" class="acoes">Ações</ion-col>
            </ion-row>

            <ion-row class="trow" *ngFor="let r of paged()">
              <ion-col size="4">
                <div class="title">{{ r.nome }}</div>
                <div class="sub">{{ r.email }}</div>
                <div class="sub">Doc: {{ r.documento }} • Tel: {{ r.telefone }}</div>
              </ion-col>

              <ion-col size="4" class="mono">
                <div class="token-line">
                  <span class="truncate">{{ r.token }}</span>
                </div>
                <ion-chip size="small">Criado: {{ r.createdAt | date:'dd/MM/yyyy HH:mm' }}</ion-chip>
                <ion-chip size="small">Expira: {{ r.expiresAt | date:'dd/MM/yyyy HH:mm' }}</ion-chip>
              </ion-col>

              <ion-col size="2">
                <ion-badge [color]="r.status === 'Ativo' ? 'success' : 'medium'">{{ r.status }}</ion-badge>
              </ion-col>

              <ion-col size="2" class="acoes">
                <ion-buttons>
                  <ion-button size="small" fill="clear" [disabled]="r.status !== 'Ativo'" (click)="revoke(r)">
                    Revogar
                  </ion-button>
                </ion-buttons>
              </ion-col>
            </ion-row>

            <ion-row *ngIf="paged().length === 0">
              <ion-col size="12" class="empty">Nenhum resultado.</ion-col>
            </ion-row>
          </ion-grid>

          <div class="pager" *ngIf="totalPages() > 1">
            <button [disabled]="page()===1" (click)="page.set(page()-1)">‹</button>
            <span>Página {{ page() }} de {{ totalPages() }}</span>
            <button [disabled]="page()===totalPages()" (click)="page.set(page()+1)">›</button>
          </div>
        </ng-template>

      </ion-card-content>
    </ion-card>
  </div>
</ion-content>