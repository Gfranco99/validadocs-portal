<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Validação de Documento</ion-title>

    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="fileInput.click()" [disabled]="loading">Selecionar um PDF</ion-button>
      <ion-button *ngIf="file" fill="clear" color="light" (click)="reset()" [disabled]="loading">Limpar</ion-button>
      <ion-button (click)="exportPdf()" [disabled]="loading || !hasResult">Exportar PDF</ion-button>
      <ion-button (click)="goHome()">Voltar a Home</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <input #fileInput type="file" accept="application/pdf" (change)="onFileChange($event)" hidden />

  <!-- Upload -->
  <ion-card class="upload-card" *ngIf="!file">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="document-text-outline"></ion-icon>
        Enviar PDF para validação
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <div class="file-drop"
           (click)="fileInput.click()"
           (dragover)="onDragOver($event)"
           (drop)="onDrop($event)"
           role="button" tabindex="0"
           (keyup.enter)="fileInput.click()"
           aria-label="Solte o PDF aqui ou clique para escolher">
        <ion-icon name="cloud-upload-outline"></ion-icon>
        <div>
          <strong>Solte o PDF aqui</strong>
          <span class="muted">ou clique para escolher</span>
        </div>
      </div>

      <ion-note color="danger" *ngIf="error">{{ error }}</ion-note>
      <ion-progress-bar *ngIf="loading" type="indeterminate"></ion-progress-bar>
    </ion-card-content>
  </ion-card>

  <!-- Resultado -->
  <ng-container *ngIf="result as r">
    <ion-grid class="val-grid">
      <ion-row class="val-row">

        <!-- ESQUERDA: Resumo -->
        <ion-col size="12" size-lg="5" class="left">
          <ion-card class="summary-card">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="shield-checkmark-outline"></ion-icon>
                Resumo da validação
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <div class="summary-metrics">
                <div class="kpi">{{ sigMetric() }}</div>
              </div>

              <ion-list class="ion-margin-top">
                <ion-item *ngFor="let s of r.validaDocsReturn?.digitalSignatureValidations"
                          lines="full" class="sig-item">
                  <ion-label class="ion-text-wrap">
                    <div class="sig-head">Assinado por: {{ normalizeAccents(s.signerName) }}</div>
                    <div class="sig-head">CPF: {{ s.cpf }}</div>
                    <div class="sig-sub">{{ s.signatureType }}</div>
                    <div class="sig-sub" *ngIf="s.isICP">ICP-Brasil</div>
                    <div class="sig-sub" *ngIf="s.iseGov">eGov.br</div>
                    <div class="sig-sub" *ngIf="s.signatureTime">
                      {{ s.signatureTime | date:'dd/MM/yyyy HH:mm' }}
                    </div>
                    <div>
                      <ion-icon name="checkmark-circle" color="success"></ion-icon>
                      <ion-label class="ion-text-wrap" [color]="validColor(s.signatureValid)">
                        {{ s.signatureValid ? 'Assinatura aprovada' : 'Assinatura reprovada' }}
                      </ion-label>
                    </div>
                  </ion-label>

                  <!-- Selo à direita -->
                  <div slot="end" class="seal-box">
                    <img
                      [src]="s.qualified === 'Enotariado'
                        ? 'assets/selo_validadocs_Enotariado.png'
                        : (s.qualified === 'ICP-RC'
                            ? 'assets/selo_validadocs_ICPRC.png'
                            : (s.isICP
                                ? 'assets/selo_validadocs_ICPBrasil.png'
                                : (s.iseGov
                                    ? 'assets/selo_validadocs_GovBr.png'
                                    : 'assets/selo_validadocs_generico.png')))"
                      alt="Selo ValidaDocs" class="seal-img-box" />
                  </div>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <!-- DIREITA -->
        <ion-col size="12" size-lg="5" class="right">
          <!-- Apontamentos -->
          <ion-card class="errorfindings-card" *ngIf="r.errorfindings?.length">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="search-outline"></ion-icon>
                Apontamentos da Validação
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                <ion-item *ngFor="let f of r.errorfindings" class="finding">
                  <ion-icon name="alert-circle" color="danger"></ion-icon>
                  <ion-label class="danger-text">{{ f }}</ion-label>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>

          <!-- Detalhes do Documento -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="document-outline"></ion-icon>
                Sobre o Documento
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item lines="full">
                <ion-label position="stacked">Nome do documento</ion-label>
                <!-- >>> aqui corrige acentuação do nome do arquivo -->
                <ion-input [value]="normalizeAccents(r.fileName)" readonly></ion-input>
              </ion-item>

              <ion-item>
                <ion-label class="with-help">
                  Status
                  <span *ngIf="r.isValid === false"
                        class="help-dot"
                        [title]="getStatusTooltip()"
                        [attr.aria-label]="'Ajuda: ' + getStatusTooltip()"
                        tabindex="0"></span>
                </ion-label>
                <ion-note [color]="validColor(r.isValid)">
                  {{ r.isValid ? 'Válido' : 'Inválido' }}
                </ion-note>
              </ion-item>

              <ion-item>
                <ion-label>Padrão das assinaturas</ion-label>
                <ion-note>{{ r.signatureType }}</ion-note>
              </ion-item>

              <ion-item>
                <ion-label>Versão do software</ion-label>
                <ion-note>{{ r.softwareVersion }}</ion-note>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <!-- Informações do Arquivo (PDF/A) -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="information-circle-outline"></ion-icon>
                PDF/A Compliance
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <ion-list class="info-list">
                <!-- PDF/A válido (mensagem fixa) -->
                <ion-item>
                  <ion-label class="with-help">
                    PDF/A válido
                    <span *ngIf="r.validaDocsReturn?.pdfValidations?.isValid === false"
                          class="help-dot"
                          title="O arquivo não atende integralmente ao padrão PDF/A."
                          aria-label="Ajuda: O arquivo não atende integralmente ao padrão PDF/A."
                          tabindex="0"></span>
                  </ion-label>
                  <ion-badge [color]="r.validaDocsReturn?.pdfValidations?.isValid ? 'success' : 'danger'">
                    {{ r.validaDocsReturn?.pdfValidations?.isValid ? 'Sim' : 'Não' }}
                  </ion-badge>
                </ion-item>

                <!-- Conformidade com o padrão (mensagem fixa) -->
                <ion-item>
                  <ion-label class="with-help">
                    Está em conformidade com padrão?
                    <span *ngIf="r.validaDocsReturn?.pdfValidations?.isPDFACompliant === false"
                          class="help-dot"
                          title="Não está conforme o nível PDF/A declarado."
                          aria-label="Ajuda: Não está conforme o nível PDF/A declarado."
                          tabindex="0"></span>
                  </ion-label>
                  <ion-badge [color]="r.validaDocsReturn?.pdfValidations?.isPDFACompliant ? 'success' : 'danger'">
                    {{ r.validaDocsReturn?.pdfValidations?.isPDFACompliant ? 'Sim' : 'Não' }}
                  </ion-badge>
                </ion-item>

                <!-- Nato digital (mensagem fixa) -->
                <ion-item>
                  <ion-label class="with-help">
                    Nato digital
                    <span *ngIf="r.validaDocsReturn?.pdfValidations?.bornDigital === false"
                          class="help-dot"
                          title="Pode ser uma digitalização; não foi gerado originalmente em meio digital."
                          aria-label="Ajuda: Pode ser uma digitalização; não foi gerado originalmente em meio digital."
                          tabindex="0"></span>
                  </ion-label>
                  <ion-badge [color]="r.validaDocsReturn?.pdfValidations?.bornDigital ? 'success' : 'danger'">
                    {{ r.validaDocsReturn?.pdfValidations?.bornDigital ? 'Sim' : 'Não' }}
                  </ion-badge>
                </ion-item>

                <!-- Nível (mensagem fixa) -->
                <ion-item>
                  <ion-label class="with-help">
                    Nível
                    <span *ngIf="!(r.validaDocsReturn?.pdfValidations?.pdfAStandard) ||
                                 r.validaDocsReturn?.pdfValidations?.pdfAStandard === 'Desconhecido'"
                          class="help-dot"
                          title="Não foi possível identificar o nível PDF/A."
                          aria-label="Ajuda: Não foi possível identificar o nível PDF/A."
                          tabindex="0"></span>
                  </ion-label>
                  <ion-note slot="end">
                    {{ r.validaDocsReturn?.pdfValidations?.pdfAStandard || 'Desconhecido' }}
                  </ion-note>
                </ion-item>

                <ion-item *ngIf="r.validaDocsReturn?.pdfValidations?.alertMessage">
                  <ion-label>Alerta</ion-label>
                  <ion-note slot="end" color="warning">
                    {{ r.validaDocsReturn?.pdfValidations?.alertMessage }}
                  </ion-note>
                </ion-item>

                <ion-item *ngIf="r.validaDocsReturn?.pdfValidations?.errorMessage">
                  <ion-label>Erro</ion-label>
                  <ion-note slot="end" color="danger">
                    {{ r.validaDocsReturn?.pdfValidations?.errorMessage }}
                  </ion-note>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>

          <!-- Certificados -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="people-outline"></ion-icon>
                {{ signatureCount() === 1 ? 'Certificado' : 'Certificados' }}
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <ion-list>
                <ion-item *ngFor="let s of r.validaDocsReturn?.digitalSignatureValidations; trackBy: trackByName"
                          lines="full" class="cert-item">
                  <ion-label class="ion-text-wrap">
                    <!-- Fonte normal (sem negrito) + acentuação corrigida -->
                    <p class="cert-subject ion-text-wrap" style="font-weight: 400; margin: 0;">
                      {{ normalizeAccents(s.endCertSubjectName) || '—' }}
                    </p>

                    <p class="cert-issuer ion-text-wrap" style="font-weight: 400;">
                      <span class="issuer-label" style="font-weight: 400;">Emissor raiz:</span>
                      <span class="issuer-value" style="font-weight: 400;">{{ normalizeAccents(s.rootIssuer) || '—' }}</span>
                    </p>

                    <p class="cert-meta" style="font-weight: 400;">{{ s.signatureType }} {{ s.signatureLevel }}</p>
                    <p class="cert-meta" *ngIf="s.signatureTime" style="font-weight: 400;">
                      Data: {{ s.signatureTime | date:'dd/MM/yyyy HH:mm' }}
                    </p>
                  </ion-label>

                  <ion-badge slot="end" [color]="sigColor(s)">
                    {{ s.signatureValid ? 'Válida' : 'Inválida' }}
                  </ion-badge>
                  <span *ngIf="s.signatureValid === false"
                        slot="end"
                        class="help-dot"
                        [title]="getSignatureTooltip(s)"
                        [attr.aria-label]="'Ajuda: ' + getSignatureTooltip(s)"
                        tabindex="0"></span>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>

      </ion-row>
    </ion-grid>
  </ng-container>
</ion-content>