<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Validação de Documento</ion-title>

    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="fileInput.click()">Selecionar um PDF</ion-button>
      <ion-button *ngIf="file" fill="clear" color="light" (click)="reset()">Limpar</ion-button>
      <ion-button routerLink="/">Voltar a Home</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <input
    #fileInput
    type="file"
    accept="application/pdf"
    (change)="onFileChange($event)"
    hidden
  />

  <ion-card class="upload-card" *ngIf="!file">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="document-text-outline"></ion-icon>
        Enviar PDF para validação
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <div
        class="file-drop"
        (click)="fileInput.click()"
        (dragover)="onDragOver($event)"
        (drop)="onDrop($event)"
        role="button"
        aria-label="Solte o PDF aqui ou clique para escolher"
      >
        <ion-icon name="cloud-upload-outline"></ion-icon>
        <div>
          <strong>Solte o PDF aqui</strong>
          <span class="muted">ou clique para escolher</span>
        </div>
      </div>

      <ion-note color="danger" *ngIf="error">{{ error }}</ion-note>
      <ion-progress-bar *ngIf="loading" type="indeterminate"></ion-progress-bar>
    </ion-card-content>
  </ion-card>

  <!-- Resultado -->
  <ng-container *ngIf="result as r">
    <ion-grid class="val-grid">
      <ion-row class="val-row">
        <!-- ESQUERDA: Resumo (5/12) -->
        <ion-col size="12" size-lg="5" class="left">
          <ion-card class="summary-card">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="shield-checkmark-outline"></ion-icon>
                Resumo da validação
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <div class="summary-metrics">
                <div class="kpi">{{ signatureCount() }} Assinaturas encontradas</div>                
              </div>

              <ion-list class="ion-margin-top">
                <ion-item *ngFor="let s of r.signatures" lines="full" class="sig-item">
                  <ion-label class="ion-text-wrap">
                    <div class="sig-head">
                      <strong class="sig-name">{{ s.endCertSubjectName }}</strong>
                    </div>
                    <div class="sig-sub">
                      {{ s.standard }} • {{ s.signatureLevel }} • {{ s.qualified || '—' }}
                    </div>
                    <div class="sig-sub" *ngIf="s.signatureTime">
                      {{ s.signatureTime | date:'dd/MM/yyyy HH:mm' }}
                    </div>
                  </ion-label>

                  <!-- Selo fixo à direita -->
                  <div slot="end" class="seal-box">
                    <img
                      src="assets/selo_validadocs_ICPBrasil.png"
                      alt="Selo ValidaDocs"
                      class="seal-img-box"
                    />
                  </div>
                </ion-item>
              </ion-list>

              <ion-item lines="none" class="approval" *ngIf="allValid()">
                <ion-icon name="checkmark-circle" color="success"></ion-icon>
                <ion-label>Assinatura aprovada.</ion-label>
              </ion-item>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <!-- DIREITA: Apontamentos + Detalhes + Info + Assinaturas (5/12) -->
        <ion-col size="12" size-lg="5" class="right">
          <ion-card class="errorfindings-card">
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="search-outline"></ion-icon>
                Apontamentos da Validação
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list *ngIf="r.errorfindings?.length; else ok">
                <ion-item *ngFor="let f of r.errorfindings" class="finding">
                  <ion-icon name="alert-circle" color="danger"></ion-icon>
                  <ion-label class="danger-text">{{ f }}</ion-label>
                </ion-item>
              </ion-list>
              <ng-template #ok>
                <div class="callout-ok" aria-live="polite">
                  <ion-icon name="checkmark-circle" color="success"></ion-icon>
                  <span>Nenhum apontamento de falha.</span>
                </div>
              </ng-template>
            </ion-card-content>
          </ion-card>

          <ion-card>
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="document-outline"></ion-icon>
                Detalhes do Documento
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item lines="full">
                <ion-label position="stacked">Nome do documento</ion-label>
                <ion-input [value]="r.fileName" readonly></ion-input>
              </ion-item>
              <ion-item>
                <ion-label>Data de validação</ion-label>
                <ion-note>{{ r.validationTime | date:'dd/MM/yyyy HH:mm' }}</ion-note>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <ion-card>
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="information-circle-outline"></ion-icon>
                Informações do Arquivo
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list class="info-list">
                <ion-item>
                  <ion-label>PDF/A válido</ion-label>
                  <ion-badge [color]="r.pdfValidations?.isValid ? 'success' : 'danger'">
                    {{ r.pdfValidations?.isValid ? 'Sim' : 'Não' }}
                  </ion-badge>
                  <ion-note slot="end">{{ r.pdfValidations?.level || '—' }}</ion-note>
                </ion-item>

                <ion-item>
                  <ion-label>LPA válido</ion-label>
                  <ion-badge [color]="r.lpaValid ? 'success' : 'medium'">
                    {{ r.lpaValid }}
                  </ion-badge>
                </ion-item>

                <ion-item>
                  <ion-label>Tipo de assinatura</ion-label>
                  <ion-note slot="end">{{ r.signatureType }}</ion-note>
                </ion-item>

                <!-- <ion-item>
                  <ion-label>Integridade</ion-label>
                  <ion-badge [color]="r.integrityValid ? 'success' : 'danger'">
                    {{ r.integrityValid ? 'OK' : 'Falhou' }}
                  </ion-badge>
                </ion-item> -->
              </ion-list>
            </ion-card-content>
          </ion-card>

          <ion-card>
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="people-outline"></ion-icon>
                Assinaturas
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                <ion-item *ngFor="let s of r.signatures">
                  <ion-label>
                    <h3>{{ s.endCertSubjectName }}</h3>
                    <p>CPF: {{ s.cpf || '—' }} • {{ s.standard }} • {{ s.signatureLevel }}</p>
                    <p>{{ s.qualified || '—' }}</p>
                    <p *ngIf="s.signatureTime">Data: {{ s.signatureTime | date:'dd/MM/yyyy HH:mm' }}</p>
                  </ion-label>
                  <ion-badge slot="end" [color]="sigColor(s)">
                    {{ s.signatureValid ? 'Válida' : 'Inválida' }}
                  </ion-badge>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>

      </ion-row>
    </ion-grid>
  </ng-container>
</ion-content>