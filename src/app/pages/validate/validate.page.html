<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Validação de Documento</ion-title>

    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="newValidation()" [disabled]="loading">
        Nova validação
      </ion-button>

      <ion-button fill="clear" (click)="exportPdf()" [disabled]="loading || !hasResult">
        Relatório
      </ion-button>

      <ion-button fill="clear" (click)="goHome()">Voltar</ion-button>
      <ion-button fill="clear" (click)="logout()" [disabled]="loading">Sair</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Inputs "reais" mas escondidos -->
  <input
    #fileInput
    type="file"
    accept="application/pdf,.p7s"
    (change)="onFileChange($event)"
    hidden
  />
  <input
    #p7sInput
    type="file"
    accept=".p7s"
    (change)="onP7sChange($event)"
    hidden
  />

  <!-- Upload (drag & drop + clique) -->
  <ion-card class="upload-card" *ngIf="!result">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="document-text-outline"></ion-icon>
        Selecionar arquivo (Formatos aceitos: pdf ou p7s)
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <!-- Dropzone do PDF -->
      <div class="file-drop"
           (click)="fileInput.click()"
           (dragover)="onDragOver($event)"
           (drop)="onDrop($event)"
           role="button" tabindex="0"
           (keyup.enter)="fileInput.click()"
           [attr.aria-label]="file ? 'Arquivo selecionado: ' + file.name : 'Solte o arquivo aqui ou clique para escolher'">
        <ion-icon name="cloud-upload-outline"></ion-icon>

        <!-- placeholder padrão -->
        <div *ngIf="!file; else fileChosen">
          <span>Solte o arquivo aqui </span>
          <span class="muted"> ou clique para escolher</span>
        </div>

        <!-- quando já houver PDF selecionado -->
        <ng-template #fileChosen>
          <div class="chosen-file">
            <ion-icon name="document-outline"></ion-icon>
            <span class="file-name">{{ file?.name }}</span>
          </div>
        </ng-template>
      </div>

      <!-- Opção: Assinatura destacada (.p7s) -->
      <ion-item lines="none" class="ion-margin-top">
        <ion-checkbox
          slot="start"
          [formControl]="form.controls.detached"
          aria-label="Assinatura destacada (.p7s)">
        </ion-checkbox>
        <ion-label>Se a assinatura for destacada, selecione o arquivo .p7s</ion-label>
      </ion-item>

      <!-- Dropzone do .p7s (quando detached) -->
      <div *ngIf="detached" class="ion-margin-top">
        <div class="file-drop secondary"
             (click)="p7sInput.click()"
             (dragover)="onDragOverP7s($event)"
             (drop)="onDropP7s($event)"
             role="button" tabindex="0"
             (keyup.enter)="p7sInput.click()"
             [attr.aria-label]="p7sFileName ? 'Assinatura selecionada: ' + p7sFileName : 'Solte o arquivo .p7s aqui ou clique para escolher'">
          <ion-icon name="key-outline"></ion-icon>

          <!-- placeholder .p7s -->
          <div *ngIf="!p7sFileName; else p7sChosen">
            <span>Adicionar arquivo de assinatura </span>
            <span class="muted">(.p7s)</span>
          </div>

          <!-- quando já houver .p7s selecionado -->
          <ng-template #p7sChosen>
            <div class="chosen-file">
              <ion-icon name="document-attach-outline"></ion-icon>
              <span class="file-name">{{ p7sFileName }}</span>
            </div>
          </ng-template>
        </div>

        <!-- Feedback de verificação .p7s -->
        <div class="ion-padding-top" *ngIf="p7sOk !== undefined">
          <ion-text color="success" *ngIf="p7sOk === true"></ion-text>
          <ion-text color="danger" *ngIf="p7sOk === false">
            <p><b>Falha na verificação .p7s:</b> {{ p7sReason }}</p>
          </ion-text>
        </div>
      </div>

      <!-- Aceite da Política -->
      <ion-item lines="none" class="ion-margin-top">
        <ion-checkbox
          slot="start"
          [formControl]="form.controls.acceptPolicy"
          aria-label="Li e aceito a Política de Privacidade">
        </ion-checkbox>
        <ion-label>
          Li e aceito a
          <a href="http://homol.assinaweb.com.br/app/content/protocolos/politica_validadocs.htm" target="_blank" rel="noopener">Política de Privacidade</a>
        </ion-label>
      </ion-item>

      <ion-note color="medium" *ngIf="!form?.value?.acceptPolicy" class="ion-margin-start">
        É necessário aceitar a Política de Privacidade para validar.
      </ion-note>

      <!-- Mensagens gerais -->
      <ion-note color="danger" *ngIf="error" class="ion-margin-top">{{ error }}</ion-note>

      <!-- Botão Validar -->
      <ion-button
        class="ion-margin-top"
        expand="block"
        color="primary"
        (click)="submit()"
        [disabled]="loading || !canValidate()">
        Validar Documento
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Resultado -->
  <ng-container *ngIf="result as r">
    <ion-grid class="val-grid">
      <ion-row class="val-row">

        <!-- ESQUERDA: Resumo -->
        <ion-col size="12" size-lg="6" class="left">
          <ion-card class="summary-card">
            <ion-card-header>
              <ion-card-title>
                Resumo da validação
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <div class="summary-metrics">
                <div class="kpi">{{ sigMetric() }}</div>
              </div>

              <ion-list class="ion-margin-top">
                <ion-item *ngFor="let s of r.validaDocsReturn?.digitalSignatureValidations"
                          lines="full" class="sig-item">
                  <ion-label class="ion-text-wrap">
                    <div class="sig-head">Assinado por: {{ normalizeAccents(s.signerName) }}</div>
                    <div class="sig-head" *ngIf="s.cpf">CPF: {{ s.cpf }}</div>
                    <div class="sig-sub">{{ s.signatureLevel }}</div>
                    <div class="sig-sub">{{ s.trustedRoot }}</div>
                    <div class="sig-sub" *ngIf="s.signatureTime">
                      {{ s.signatureTime | date:'dd/MM/yyyy HH:mm' }}
                    </div>
                    <div>
                      <ion-icon name="checkmark-circle" color="success"></ion-icon>
                      <ion-label class="ion-text-wrap" [color]="validColor(s.signatureValid)">
                        {{ s.signatureValid ? 'Assinatura aprovada' : 'Assinatura reprovada' }}
                      </ion-label>
                    </div>
                  </ion-label>

                  <div slot="end" class="seal-box">
                    <img [src]="getImgTrustedRoot(s)" alt="Selo ValidaDocs" class="seal-img-box" />
                  </div>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <!-- DIREITA -->
        <ion-col size="12" size-lg="6" class="right">
          <!-- Apontamentos -->
          <ion-card class="errorfindings-card" *ngIf="((r.errorfindings?.length || 0) > 0)">
            <ion-card-header class="card-title-row">
              <ion-card-title>
                Apontamentos da Validação
              </ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <ion-list>
                <ion-item *ngFor="let f of r.errorfindings" class="finding">
                  <ion-label class="ion-text-wrap finding-label">
                    <span class="danger-text">{{ f }}</span>
                  </ion-label>
                </ion-item>

                <ion-item *ngIf="getStatusTooltip()" class="finding">
                  <ion-label class="ion-text-wrap finding-label">
                    <span class="danger-text">{{ getStatusTooltip() }}</span>
                  </ion-label>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>

          <!-- Detalhes do Documento -->
          <ion-card class="details-card">
            <ion-card-header>
              <ion-card-title>Sobre o Documento</ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <ion-item lines="full">
                <ion-label position="stacked">Nome do documento</ion-label>
                <ion-input class="doc-name" [value]="normalizeAccents(r.fileName)" readonly></ion-input>
              </ion-item>

              <ion-item lines="full">
                <ion-label class="with-help">Status</ion-label>
                <div slot="end" style="display:flex; align-items:center; height:100%;">
                  <ion-badge class="pill" [color]="r.isValid ? 'success' : 'danger'">
                    {{ r.isValid ? 'Válido' : 'Inválido' }}
                  </ion-badge>
                </div>
              </ion-item>

              <!-- ✅ MOVIDO PARA CÁ (logo abaixo de Status) -->
              <ion-item lines="full">
                <ion-label class="with-help">Nato digital</ion-label>
                <div slot="end" style="display:flex; align-items:center; height:100%;">
                  <ion-badge class="pill" [color]="r.validaDocsReturn?.pdfValidations?.bornDigital ? 'success' : 'danger'">
                    {{ r.validaDocsReturn?.pdfValidations?.bornDigital ? 'Sim' : 'Não' }}
                  </ion-badge>
                </div>
              </ion-item>

              <ion-item lines="full">
                <ion-label>Padrão das assinaturas</ion-label>
                <div slot="end" style="display:flex; align-items:center; height:100%;">
                  <ion-note>{{ r.signatureType }}</ion-note>
                </div>
              </ion-item>

              <ion-item lines="full">
                <ion-label>Versão do software</ion-label>
                <div slot="end" style="display:flex; align-items:center; height:100%;">
                  <ion-note>{{ r.softwareVersion }}</ion-note>
                </div>
              </ion-item>
            </ion-card-content>
          </ion-card>

          <!-- Informações do Arquivo (PDF/A) -->
          <ion-card>
            <ion-card-header>
              <ion-card-title>PDF/A Compliance</ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <ion-list class="info-list">
                <ion-item lines="full">
                  <ion-label class="with-help">PDF/A válido</ion-label>
                  <div slot="end" style="display:flex; align-items:center; height:100%;">
                    <ion-badge class="pill" [color]="r.validaDocsReturn?.pdfValidations?.isValid ? 'success' : 'danger'">
                      {{ r.validaDocsReturn?.pdfValidations?.isValid ? 'Sim' : 'Não' }}
                    </ion-badge>
                  </div>
                </ion-item>

                <ion-item lines="full">
                  <ion-label class="with-help">Está em conformidade com padrão?</ion-label>
                  <div slot="end" style="display:flex; align-items:center; height:100%;">
                    <ion-badge class="pill" [color]="r.validaDocsReturn?.pdfValidations?.isPDFACompliant ? 'success' : 'danger'">
                      {{ r.validaDocsReturn?.pdfValidations?.isPDFACompliant ? 'Sim' : 'Não' }}
                    </ion-badge>
                  </div>
                </ion-item>

                <!-- ❌ REMOVIDO DAQUI: Nato digital -->

                <ion-item lines="full">
                  <ion-label class="with-help">Nível</ion-label>
                  <div slot="end" style="display:flex; align-items:center; height:100%;">
                    <ion-note>{{ r.validaDocsReturn?.pdfValidations?.pdfAStandard || 'Desconhecido' }}</ion-note>
                  </div>
                </ion-item>

                <ion-item *ngIf="r.validaDocsReturn?.pdfValidations?.alertMessage" lines="full">
                  <ion-label>Alerta</ion-label>
                  <div slot="end" style="display:flex; align-items:center; height:100%;">
                    <ion-note color="warning">{{ r.validaDocsReturn?.pdfValidations?.alertMessage }}</ion-note>
                  </div>
                </ion-item>

                <ion-item *ngIf="r.validaDocsReturn?.pdfValidations?.errorMessage" lines="full">
                  <ion-label>Erro</ion-label>
                  <div slot="end" style="display:flex; align-items:center; height:100%;">
                    <ion-note color="danger">{{ r.validaDocsReturn?.pdfValidations?.errorMessage }}</ion-note>
                  </div>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>

          <!-- Certificados (cada assinatura em um card) -->
          <ng-container *ngIf="r.validaDocsReturn?.digitalSignatureValidations as certList">
            <ng-container *ngFor="let s of certList; let i = index; trackBy: trackByName">
              <ion-card class="cert-card ion-margin-bottom">
                <ion-card-header></ion-card-header>

                <ion-card-content>
                  <ion-item lines="full" class="cert-item">
                    <ion-label class="ion-text-wrap">
                      <div class="cert-title-row">
                        <span class="cert-title">
                          Certificado
                          <ng-container *ngIf="certList.length > 1">
                            {{ i + 1 }}
                          </ng-container>
                        </span>

                        <ion-badge class="pill" [color]="sigColor(s)">
                          {{ s.signatureValid ? 'Válida' : 'Inválida' }}
                        </ion-badge>
                      </div>

                      <p class="cert-subject ion-text-wrap" style="margin:0;">
                        {{ normalizeAccents(s.endCertSubjectName) || '—' }}
                      </p>

                      <p class="cert-meta" *ngIf="s.certificateStartDate">
                        <span class="issuer-label">Emitido em:</span>
                        <span class="issuer-value">{{ s.certificateStartDate | date:'dd/MM/yyyy HH:mm' }}</span>
                      </p>

                      <p class="cert-meta" *ngIf="s.certificateEndDate">
                        <span class="issuer-label">Válido até: </span>
                        <span class="issuer-value">{{ s.certificateEndDate | date:'dd/MM/yyyy HH:mm' }}</span>
                      </p>

                      <p class="cert-issuer ion-text-wrap">
                        <span class="issuer-label">Emissor raiz:</span>
                        <span class="issuer-value">{{ normalizeAccents(s.rootIssuer) || '—' }}</span>
                      </p>

                      <p class="cert-meta" *ngIf="s.signatureType || s.signatureLevel">
                        <span class="issuer-value">{{ s.signatureType }} / {{ s.signatureLevel }}</span>
                      </p>

                      <!-- Carimbos de tempo (Accordion Ionic) -->
                      <ng-container *ngIf="($any(s)?.timeStamps || $any(s)?.timestamps || $any(s)?.timeStampValidations) as tsList">
                        <div class="ts-inside-cert ion-margin-top" *ngIf="tsList?.length">
                          <ion-accordion-group>
                            <ion-accordion *ngFor="let ts of tsList; let j = index"
                                           [value]="'ts-'+i+'-'+j"
                                           class="ts-outline-accordion">
                              <!-- Header do accordion estilo "file bar" -->
                              <ion-item slot="header" lines="none" class="ts-header ts-outline" button>
                                <ion-label>Carimbo de tempo</ion-label>
                                <ion-icon name="chevron-forward-outline" slot="end" class="ts-chevron"></ion-icon>
                              </ion-item>

                              <!-- Conteúdo expandido -->
                              <div slot="content" class="ion-padding">
                                <ion-list lines="none">
                                  <ion-item>
                                    <ion-label>Data do carimbo</ion-label>
                                    <ion-note slot="end">{{ formatDate(tsDate(ts)) }}</ion-note>
                                  </ion-item>

                                  <ion-item *ngIf="tsSigner(ts)?.issuer">
                                    <ion-label>Assinante</ion-label>
                                    <ion-note slot="end">{{ normalizeAccents(tsSigner(ts)?.issuer) }}</ion-note>
                                  </ion-item>

                                  <ion-item *ngIf="tsSigner(ts)?.tsa">
                                    <ion-label>Emissor TSA</ion-label>
                                    <ion-note slot="end">{{ normalizeAccents(tsSigner(ts)?.tsa) }}</ion-note>
                                  </ion-item>

                                  <ion-item *ngIf="tsSigner(ts)?.certificateStartDate">
                                    <ion-label>Emitido em</ion-label>
                                    <ion-note slot="end">{{ formatDate(tsSigner(ts)?.certificateStartDate) }}</ion-note>
                                  </ion-item>

                                  <ion-item *ngIf="tsSigner(ts)?.certificateEndDate">
                                    <ion-label>Válido até</ion-label>
                                    <ion-note slot="end">{{ formatDate(tsSigner(ts)?.certificateEndDate) }}</ion-note>
                                  </ion-item>
                                </ion-list>
                              </div>
                            </ion-accordion>
                          </ion-accordion-group>
                        </div>
                      </ng-container>
                      <!-- /Carimbos de tempo -->
                    </ion-label>
                  </ion-item>
                </ion-card-content>
              </ion-card>
            </ng-container>
          </ng-container>

        </ion-col>
      </ion-row>
    </ion-grid>
  </ng-container>
</ion-content>